<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flex- Playful Moves</title>

  <style>
  #instrucciones{
    display:none;
  }
  </style>
  </head>
  <body>
  <script>
let sensor = null; // https://developer.mozilla.org/en-US/docs/Web/API/Sensor_APIs#defensive_programming
let qA = [0, 0, 0, 1];
let qB = [0, 0, 0, 1];
let areSaved = 0;
let saveA = false;
let saveB = false;
let delta = 0;

function createUI(){
  let app = document.getElementById("app");
  let bA = document.createElement("button");
  bA.innerText = "A";
  bA.addEventListener("click", doSaveA);
  app.appendChild(bA);

  let bB = document.createElement("button");
  bB.innerText = "B";
  bB.addEventListener("click", doSaveB);
  app.appendChild(bB);
}

function createDebugUI(){
  let debug = document.getElementById("debug");
  let t = document.createElement("p");
  t.id = "quaternion";
  t.innerText = "hola";
  debug.appendChild(t);

  let tA = document.createElement("p");
  tA.id = "quaternionA";
  debug.appendChild(tA);

  let tB = document.createElement("p");
  tB.id = "quaternionB";
  debug.appendChild(tB);

  let slider = document.createElement("input");
  slider.setAttribute("type", "range");
  slider.min = 0;
  slider.max = 1;
  slider.step = 0.01;
  slider.id = "slider";
  debug.appendChild(slider);

  let td = document.createElement("p");
  td.id = "delta";
  debug.appendChild(td);

  let tdA = document.createElement("p");
  tdA.id = "deltaA";
  debug.appendChild(tdA);

  let tdB = document.createElement("p");
  tdB.id = "deltaB";
  debug.appendChild(tdB);
}

function updateDebugUI(q, qA, qB, param, deltaA, deltaB){
  document.getElementById("quaternion").textContent = `${q[0].toFixed(3)} ${q[1].toFixed(3)} ${q[2].toFixed(3)} ${q[3].toFixed(3)}`;
  document.getElementById("quaternionA").textContent = `${qA[0].toFixed(3)} ${qA[1].toFixed(3)} ${qA[2].toFixed(3)} ${qA[3].toFixed(3)}`;
  document.getElementById("quaternionB").textContent = `${qB[0].toFixed(3)} ${qB[1].toFixed(3)} ${qB[2].toFixed(3)} ${qB[3].toFixed(3)}`;
  document.getElementById("slider").value = param;
  document.getElementById("delta").textContent = param.toFixed(5);
  document.getElementById("deltaA").textContent = deltaA.toFixed(5);
  document.getElementById("deltaB").textContent = deltaB.toFixed(5);
}

try{
  // https://developer.mozilla.org/en-US/docs/Web/API/AbsoluteOrientationSensor
  const sensor = new AbsoluteOrientationSensor({ frequency: 60 });
  Promise.all([
    navigator.permissions.query({ name: "accelerometer" }),
    navigator.permissions.query({ name: "magnetometer" }),
    navigator.permissions.query({ name: "gyroscope" }),
  ]).then((results) => {
    if (results.every((result) => result.state === "granted")) {
      // START!
      sensor.start();
      document.getElementById("texto").remove();
      document.getElementById("instrucciones").style.display = "block";

    } else {
      console.log("No permissions to use AbsoluteOrientationSensor.");
    }
  });
  
  sensor.addEventListener("reading", () => {
    let q = sensor.quaternion;
    if(saveA){ 
      qA = structuredClone(q);
    }
    if(saveB){
      qB = structuredClone(q);
    }
    if((saveA||saveB) && areSaved>1){
      // calculate total distance between A and B
      // to be able to calculate where we are in between
      delta = distance(qA, qB);
    }
    saveA = false;
    saveB = false;

    let deltaA = distance(q, qA);
    let deltaB = distance(q, qB);

    let param = 0;
    if(areSaved>1){
      // calculate param, where 0 is closer to A and 1 is closer to B
      param = deltaA/(deltaA+deltaB);
      // too far from A, overflow:
      if(deltaA/delta > 1 && deltaB/delta < 1){ param = 1 + deltaB/delta; }
      // too far from B, underflow:
      else if(deltaB/delta > 1){ param = -deltaA/delta; }
    }
    updateDebugUI(q, qA, qB, param, deltaA, deltaB);
  });
}
catch (error) {
  //document.getElementById("texto").textContent = error.name;
  // Handle construction errors.
  if (error.name === "SecurityError") {
    // See the note above about permissions policy.
    console.log("Sensor construction was blocked by a permissions policy.");
  } else if (error.name === "ReferenceError") {
    console.log("Sensor is not supported by the User Agent.");
  } else {
    throw error;
  }
}


function distance(q1, q2){ // https://math.stackexchange.com/questions/90081/quaternion-distance
  let internalProduct = q1[0]*q2[0] + q1[1]*q2[1] + q1[2]*q2[2] + q1[3]*q2[3]; 
  return (1-internalProduct*internalProduct);
}

function doSaveA(){
  saveA = true;
  areSaved = areSaved + 1;
  let x = navigator.vibrate(100);
}

function doSaveB(){
  saveB = true;
  areSaved = areSaved + 1;
  let x = navigator.vibrate(100);
}

function start(){
  document.getElementById("instrucciones").style.display = "none";
  createUI();
  createDebugUI();
}
  </script>
  <main>
  <p id="texto">Esta aplicación no funciona con tu navegador, prueba utilizando Chrome 67+ en Android, Samsung Internet 9.0+, u Opera 48+ en Android.</p>
  <div id="instrucciones">
    <h1>flex</h1>
    <ol>
        <li>coloca el dispositivo de forma distal a la articulación a ejercitar.</li>
        <li>realiza una extensión máxima y presiona el botón A para guardar la posición.</li>
        <li>realiza una flexión máxima y presiona el botón B para guardar la posición.</li>
        <li>flexiona y extiende tratando de llegar a los puntos guardados.</li>
    </ol>
    <button id="start" onclick="start()">comenzar</button>
  </div>
  <div id="debug"></div>
  <div id="app"></div>
  </main>
  <footer>
  </footer>
</body></html>
